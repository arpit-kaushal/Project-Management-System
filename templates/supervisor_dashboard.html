<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supervisor Dashboard - Project Management System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <div class="dashboard-header">
                <div>
                    <h1>Supervisor Dashboard</h1>
                    <p>Welcome, {{ supervisor.name }}</p>
                    <p><strong>Domain:</strong> {{ supervisor.domain }} | <strong>School:</strong> {{ supervisor.school }}</p>
                </div>
                <div>
                    <a href="{{ url_for('logout') }}" class="btn btn-secondary">Logout</a>
                </div>
            </div>
        </header>
        
        <div class="main-content">
            <!-- Notifications Section -->
            {% if notifications %}
            <div class="dashboard-section">
                <h3>Notifications</h3>
                {% for notification in notifications %}
                <div class="card notification-card">
                    <div class="notification-header">
                        <h4>{{ notification.title }}</h4>
                        <span class="notification-date">{{ notification.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                    </div>
                    <p>{{ notification.message }}</p>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Supervised Groups -->
            <div class="dashboard-section">
                <h3>My Supervised Groups ({{ supervised_groups|length }}/3)</h3>
                {% if supervised_groups %}
                    {% for group in supervised_groups %}
                    <div class="card">
                        <div class="card-header">{{ group.name }}</div>
                        <p><strong>Project Title:</strong> {{ group.project_title or 'Not set' }}</p>
                        <p><strong>Branch:</strong> {{ group.branch }}</p>
                        <p><strong>Year:</strong> {{ group.year }}</p>
                        <p><strong>Document Link:</strong> 
                            {% if group.document_link %}
                                <a href="{{ group.document_link }}" target="_blank">View Documents</a>
                            {% else %}
                                Not set
                            {% endif %}
                        </p>
                        
                        <h4>Group Members</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Roll Number</th>
                                    <th>Presentation</th>
                                    <th>Documents</th>
                                    <th>Collaboration</th>
                                    <th>Total</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in group.students %}
                                <tr>
                                    <td>{{ student.name }}</td>
                                    <td>{{ student.roll_number }}</td>
                                    <td>
                                        <input type="number" id="presentation-{{ student.id }}" 
                                               value="{{ student.marks[0].presentation if student.marks else 0 }}" 
                                               min="0" max="10" step="0.5">
                                    </td>
                                    <td>
                                        <input type="number" id="documents-{{ student.id }}" 
                                               value="{{ student.marks[0].documents if student.marks else 0 }}" 
                                               min="0" max="10" step="0.5">
                                    </td>
                                    <td>
                                        <input type="number" id="collaboration-{{ student.id }}" 
                                               value="{{ student.marks[0].collaboration if student.marks else 0 }}" 
                                               min="0" max="10" step="0.5">
                                    </td>
                                    <td data-student-total="{{ student.id }}">
                                        {{ student.marks[0].total if student.marks else 0 }}/30
                                    </td>
                                    <td>
                                        <button class="btn btn-primary" onclick="assignMarks({{ student.id }})">
                                            <span class="btn-text">Assign Marks</span>
                                            <span class="btn-loading hidden">Assigning...</span>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endfor %}
                {% else %}
                    <p>You are not supervising any groups yet.</p>
                {% endif %}
            </div>
            
            <!-- Pending Supervisor Requests -->
            <div class="dashboard-section">
                <h3>Pending Supervisor Requests</h3>
                {% if pending_requests %}
                    {% for request in pending_requests %}
                    <div class="card">
                        <p><strong>Group:</strong> {{ request.group.name }}</p>
                        <p><strong>Branch:</strong> {{ request.group.branch }}</p>
                        <p><strong>Year:</strong> {{ request.group.year }}</p>
                        <p><strong>Members:</strong> 
                            {% for student in request.group.students %}
                                {{ student.name }}{% if not loop.last %}, {% endif %}
                            {% endfor %}
                        </p>
                        <div class="request-actions">
                            <button class="btn btn-success respond-supervisor-request" 
                                    data-request-id="{{ request.id }}" 
                                    data-action="accept">
                                <span class="btn-text">Accept</span>
                                <span class="btn-loading hidden">Processing...</span>
                            </button>
                            <button class="btn btn-danger respond-supervisor-request" 
                                    data-request-id="{{ request.id }}" 
                                    data-action="reject">
                                <span class="btn-text">Reject</span>
                                <span class="btn-loading hidden">Processing...</span>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p>No pending requests.</p>
                {% endif %}
            </div>
            
            <!-- Supervisor Change Requests -->
            {% if supervisor_change_requests %}
            <div class="dashboard-section">
                <h3>Supervisor Change Requests</h3>
                <p class="info-text">Groups requesting to change you as their supervisor. These requests are pending FIC approval.</p>
                {% for change_request in supervisor_change_requests %}
                <div class="card">
                    <p><strong>Group:</strong> {{ change_request.group.name }}</p>
                    <p><strong>Requested New Supervisor:</strong> {{ change_request.new_supervisor.name }}</p>
                    <p><strong>Reason:</strong> {{ change_request.reason or 'No reason provided' }}</p>
                    <p><strong>Submitted:</strong> {{ change_request.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    <div class="status-badge status-pending">Pending FIC Approval</div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Panel Memberships -->
            <div class="dashboard-section">
                <h3>My Panel Memberships</h3>
                {% if supervisor.panel_memberships %}
                    {% for membership in supervisor.panel_memberships %}
                    <div class="card">
                        <p><strong>Group:</strong> {{ membership.panel.group.name }}</p>
                        <p><strong>Project Title:</strong> {{ membership.panel.group.project_title or 'Not set' }}</p>
                        <p><strong>Assigned by:</strong> {{ membership.panel.fic.name }}</p>
                        <p><strong>Document Link:</strong> 
                            {% if membership.panel.group.document_link %}
                                <a href="{{ membership.panel.group.document_link }}" target="_blank">View Documents</a>
                            {% else %}
                                Not set
                            {% endif %}
                        </p>
                        <!-- Show if this is also a supervised group -->
                        {% if membership.panel.group.supervisor_id == supervisor.id %}
                        <div class="status-badge status-accepted" style="background-color: #d4edda; color: #155724;">
                            Also Supervising This Group
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <p>You are not assigned to any panels.</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
        // Initialize dashboard functionality
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Supervisor dashboard initialized');
            
            // Set up supervisor request response buttons
            const respondSupervisorRequestButtons = document.querySelectorAll('.respond-supervisor-request');
            respondSupervisorRequestButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const requestId = this.dataset.requestId;
                    const action = this.dataset.action;
                    const button = this;
                    respondToSupervisorRequest(requestId, action, button);
                });
            });
        });
        
        function respondToSupervisorRequest(requestId, action, button) {
            const btnText = button.querySelector('.btn-text');
            const btnLoading = button.querySelector('.btn-loading');
            
            // Show loading state
            btnText.classList.add('hidden');
            btnLoading.classList.remove('hidden');
            button.disabled = true;
            
            fetch('/respond_supervisor_request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    request_id: requestId,
                    action: action
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showNotification(data.message, 'error');
                    btnText.classList.remove('hidden');
                    btnLoading.classList.add('hidden');
                    button.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                btnText.classList.remove('hidden');
                btnLoading.classList.add('hidden');
                button.disabled = false;
                showNotification('Network error occurred', 'error');
            });
        }
        
        function assignMarks(studentId) {
            const presentation = parseFloat(document.getElementById(`presentation-${studentId}`).value) || 0;
            const documents = parseFloat(document.getElementById(`documents-${studentId}`).value) || 0;
            const collaboration = parseFloat(document.getElementById(`collaboration-${studentId}`).value) || 0;
            
            // Validate marks
            if (presentation < 0 || presentation > 10 || 
                documents < 0 || documents > 10 || 
                collaboration < 0 || collaboration > 10) {
                showNotification('Marks must be between 0 and 10', 'error');
                return;
            }
            
            const button = document.querySelector(`button[onclick="assignMarks(${studentId})"]`);
            const btnText = button.querySelector('.btn-text');
            const btnLoading = button.querySelector('.btn-loading');
            
            // Show loading state
            btnText.classList.add('hidden');
            btnLoading.classList.remove('hidden');
            button.disabled = true;
            
            fetch('/assign_marks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    student_id: studentId,
                    presentation: presentation,
                    documents: documents,
                    collaboration: collaboration
                })
            })
            .then(response => response.json())
            .then(data => {
                // Hide loading state
                btnText.classList.remove('hidden');
                btnLoading.classList.add('hidden');
                button.disabled = false;
                
                if (data.success) {
                    showNotification(data.message, 'success');
                    // Update total display
                    const total = presentation + documents + collaboration;
                    const totalElement = document.querySelector(`[data-student-total="${studentId}"]`);
                    if (totalElement) {
                        totalElement.textContent = `${total}/30`;
                    }
                } else {
                    showNotification(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                btnText.classList.remove('hidden');
                btnLoading.classList.add('hidden');
                button.disabled = false;
                showNotification('Network error occurred', 'error');
            });
        }
        
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());
            
            // Create new notification
            const notification = document.createElement('div');
            notification.className = `notification alert alert-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                min-width: 300px;
                max-width: 500px;
                animation: slideIn 0.3s ease;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; font-size: 18px; cursor: pointer; color: inherit;">
                        Ã—
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
        
        // Add CSS for animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            .hidden { display: none; }
            
            .notification-card {
                margin-bottom: 1rem;
                border-left: 4px solid #3498db;
            }
            
            .notification-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 0.5rem;
            }
            
            .notification-date {
                color: #7f8c8d;
                font-size: 0.9em;
            }
            
            .info-text {
                color: #5a6c7d;
                margin-bottom: 1rem;
                font-style: italic;
            }
            
            @media (max-width: 768px) {
                .notification-header {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 0.5rem;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>